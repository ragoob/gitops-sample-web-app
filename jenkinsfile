pipeline {
  agent any
  environment {
    WORKSPACE = pwd()
    CONFIG_REPO_URL = "https://github.com/ragoob/gitops-config.git"
  }

  stages {
      stage('unit-test') {
      agent {
        docker
      {
          image 'golang'
          args '-u root'
      }
      }
      steps {
        echo 'Unit test excuting'
        sh 'make unit-tests'
      }
      }
    stage('Build') {
      steps {
        sh "docker build  -t regoo707/sum-service:${GIT_COMMIT.take(8)} ."
        withCredentials([usernamePassword(credentialsId: 'ci-docker-login',
         usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
          sh "docker login -u ${USERNAME} -p ${PASSWORD}"
          sh "docker push regoo707/sum-service:${GIT_COMMIT.take(8)}"
         }
      }
    }

    stage('create-master-config-pr'){
      agent {
        docker
      {
          image 'regoo707/gh'
      }
      }
      steps {
         withCredentials([string(credentialsId: 'git_hub_token', variable: 'GH_TOKEN'),
         string(credentialsId: 'git_email', variable: 'GIT_CONFIG_EMAIL'),
         string(credentialsId: 'git_name', variable: 'GIT_CONFIG_NAME')
         
         ]) {
                    cleanWs()
                    sh "git clone ${CONFIG_REPO_URL}"
                    sh "cd gitops-config"
                    sh "git checkout -b promote_production"
                    sh "touch mytext.txt"
                    sh "git add . && git commit -m 'promote production'"
                    sh "git config --global user.name '${env.GIT_CONFIG_NAME}'"
                    sh "git config --global  user.email '${env.GIT_CONFIG_EMAIL}'"
                    sh "git push --set-upstream origin promote_production"
                    sh 'gh pr create --base main --head promote_production --title "Promote production" --body "Promote production"'

                }
      }
    }
  }
}
