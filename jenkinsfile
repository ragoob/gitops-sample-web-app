pipeline {
  agent any
  environment {
    WORKSPACE = pwd()
  }

  stages {
      stage('unit-test') {
      agent {
        docker
      {
          image 'golang'
          args '-u root'
      }
      }
      steps {
        echo 'Unit test excuting'
        sh 'make unit-tests'
      }
      }
    stage('Build') {
      steps {
        sh "docker build  -t regoo707/sum-service:${GIT_COMMIT.take(8)} ."
        withCredentials([usernamePassword(credentialsId: 'ci-docker-login',
         usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
          sh "docker login -u ${USERNAME} -p ${PASSWORD}"
          sh "docker push regoo707/sum-service:${GIT_COMMIT.take(8)}"
         }
      }
    }

    stage('create-master-config-pr'){
      agent {
        docker
      {
          image 'regoo707/gh'
      }
      }
      steps {
         withCredentials([string(credentialsId: 'git_hub_token', variable: 'SECRET')]) {
                    sh "gh auth login --with-token ${env.SECRET}"
                    sh "gh repo list"
                }
      }
    }
  }
}
