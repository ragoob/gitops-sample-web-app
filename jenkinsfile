pipeline {
  agent any
  environment {
    HOME= '/tmp'
    CONFIG_REPO_URL = "github.com/ragoob/gitops-config.git"
  }

  stages {
      stage('unit-test') {
      agent {
        docker
      {
          image 'golang'
          args '-u root'
      }
      }
      steps {
        echo 'Unit test excuting'
        sh 'make unit-tests'
      }
      }
    stage('Build') {
      steps {
        sh "docker build  -t regoo707/sum-service:${GIT_COMMIT.take(8)} ."
        withCredentials([usernamePassword(credentialsId: 'ci-docker-login',
         usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
          sh "docker login -u ${USERNAME} -p ${PASSWORD}"
          sh "docker push regoo707/sum-service:${GIT_COMMIT.take(8)}"
         }
      }
    }

    stage('create-master-config-pr'){
      agent {
        docker
      {
          image 'regoo707/gh'
      }
      }
      steps {
         withCredentials([string(credentialsId: 'git_hub_token', variable: 'GH_TOKEN'),
         string(credentialsId: 'git_email', variable: 'GIT_CONFIG_EMAIL'),
         string(credentialsId: 'git_name', variable: 'GIT_CONFIG_NAME')
         
         ]) {
                    
                    sh "rm -rf * && rm -rf .git"
                    sh "git clone https://ragoob:${GH_TOKEN}@${CONFIG_REPO_URL}"
                    sh "cd gitops-config && git remote set-url origin https://ragoob:${GH_TOKEN}@${CONFIG_REPO_URL}"
                    sh "cd gitops-config && git config --global user.email \"${env.GIT_CONFIG_EMAIL}\""
                    sh "cd gitops-config && git config --global user.name  \"${env.GIT_CONFIG_NAME}\""
                    sh "cd gitops-config && git checkout -b promotion-prod-version-${GIT_COMMIT.take(8)}"
                    sh "cd gitops-config && echo 'test' > mytext.txt"
                    sh "cd gitops-config && git add . && git commit -m 'change app version to ${GIT_COMMIT.take(8)}'"
                    sh "cd gitops-config && git push --set-upstream origin promotion-prod-version-${GIT_COMMIT.take(8)}"
                    sh "cd gitops-config && gh pr create --base main --head promotion-prod-version-${GIT_COMMIT.take(8)} --title \"Promote production to version ${GIT_COMMIT.take(8)}\" --body \"Promote production\""

                }
      }
    }
  }
}
